{% extends "base.html" %}

{% block title %}Analysis for {{ ticker }}{% endblock %}

{% block content %}
  <div class="container">
    <header class="result-header">
      <h1>Analysis for {{ ticker }}</h1>
      <div class="actions">
        <a class="btn secondary" href="{{ url_for('index') }}">New Analysis</a>
        <form action="{{ url_for('reset_cache') }}" method="post" class="inline-form">
          <input type="hidden" name="ticker" value="{{ ticker }}">
          <button type="submit" class="btn">Reset Cache</button>
        </form>
      </div>
    </header>

    <!-- Include Tab Navigation -->
    {% include "partials/_tabs.html" %}

    <!-- Include Tab Contents -->
    {% include "partials/_metrics.html" %}
    {% include "partials/_dcf.html" %}
    {% include "partials/_transcripts.html" %}
  </div>

  <!-- Modal for Chart Popup -->
  <div id="chartModal" class="modal">
    <div class="modal-content">
      <span class="close-modal">&times;</span>
      <h3 id="chartTitle"></h3>
      <canvas id="metricChart"></canvas>
    </div>
  </div>

  <!-- Inline JavaScript for Modal & Charts (or move into a separate file) -->
  <script>
    // Modal Chart for Key Metrics
    const historicalData = {{ metrics.historical_metrics | tojson | safe }};
    const years = historicalData.map(item => item.year);
    let metricChart;
    function createChart(chartType, metricField, chartTitle) {
      const ctx = document.getElementById('metricChart').getContext('2d');
      const dataValues = historicalData.map(item => item[metricField]);
      if (metricChart) { metricChart.destroy(); }
      metricChart = new Chart(ctx, {
        type: chartType,
        data: {
          labels: years,
          datasets: [{
            label: chartTitle,
            data: dataValues,
            backgroundColor: chartType === 'bar' ? 'rgba(54, 162, 235, 0.6)' : 'rgba(75, 192, 192, 0.6)',
            borderColor: chartType === 'bar' ? 'rgba(54, 162, 235, 1)' : 'rgba(75, 192, 192, 1)',
            borderWidth: 1,
            borderRadius: chartType === 'bar' ? 4 : 0,
            fill: false,
            tension: chartType === 'line' ? 0.1 : 0
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: '#333',
              titleFont: { size: 14 },
              bodyFont: { size: 12 }
            }
          },
          scales: {
            x: {
              grid: { display: false, drawBorder: false },
              ticks: { font: { family: 'Roboto, sans-serif', size: 12 } }
            },
            y: {
              beginAtZero: true,
              grid: { display: false, drawBorder: false },
              ticks: { font: { family: 'Roboto, sans-serif', size: 12 } }
            }
          }
        }
      });
    }
    const modal = document.getElementById('chartModal');
    const chartTitleElem = document.getElementById('chartTitle');
    const closeModal = document.querySelector('.close-modal');
    closeModal.addEventListener('click', () => { modal.style.display = 'none'; });
    window.addEventListener('click', (event) => { if (event.target == modal) { modal.style.display = 'none'; } });
    document.querySelectorAll('.clickable').forEach(card => {
      card.addEventListener('click', function() {
        const metricField = this.getAttribute('data-metric');
        const chartType = this.getAttribute('data-chart-type');
        const title = this.getAttribute('data-title');
        chartTitleElem.textContent = title;
        createChart(chartType, metricField, title);
        modal.style.display = 'flex';
      });
    });

    // Minimalistic DCF Bar Chart
    {% if dcf_results %}
      const dcfResults = {{ dcf_results | tojson | safe }};
      const sortedDCF = Object.entries(dcfResults).sort((a, b) => parseFloat(a[0]) - parseFloat(b[0]));
      const dcfLabels = sortedDCF.map(entry => entry[0]);
      const dcfData = sortedDCF.map(entry => parseFloat(entry[1].toFixed(2)));
      const ctxDCF = document.getElementById('dcfChart').getContext('2d');
      const dcfChart = new Chart(ctxDCF, {
        type: 'bar',
        data: {
          labels: dcfLabels,
          datasets: [{
            label: 'Share Price',
            data: dcfData,
            backgroundColor: 'rgba(52, 152, 219, 0.6)',
            borderColor: 'rgba(41, 128, 185, 1)',
            borderWidth: 1,
            borderRadius: 4
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: '#333',
              titleFont: { size: 14 },
              bodyFont: { size: 12 }
            }
          },
          scales: {
            x: {
              grid: { display: false, drawBorder: false },
              ticks: { font: { family: 'Roboto, sans-serif', size: 12 } }
            },
            y: {
              beginAtZero: true,
              grid: { display: false, drawBorder: false },
              ticks: { font: { family: 'Roboto, sans-serif', size: 12 } }
            }
          }
        }
      });
    {% endif %}
  </script>
{% endblock %}
